# Feature Engineering Configuration
# Based on TRADING_STRATEGY_AND_ML_DESIGN.md

service:
  name: "feature-engineering-service"
  version: "1.0.0"

# Data Sources
clickhouse:
  aggregates_table: "aggregates"
  external_tables:
    - "external_economic_calendar"
    - "external_fred_economic"
    - "external_crypto_sentiment"
    - "external_fear_greed_index"
    - "external_commodity_prices"
    - "external_market_sessions"
  output_table: "ml_training_data"

# Multi-Timeframe Configuration
timeframes:
  m5: "5m"
  m15: "15m"
  h1: "1h"
  h4: "4h"
  d1: "1d"
  w1: "1w"

# Primary trading pair
primary_pair: "XAU/USD"

# Feature Groups (72 total features - v2.3 with Fibonacci)
feature_groups:

  # TIER 1: CRITICAL FEATURES (50%+ Importance)

  # 1. News/Economic Calendar Features (20% - 8 features)
  news_calendar:
    enabled: true
    importance: 0.20
    features:
      - upcoming_high_impact_events_4h
      - time_to_next_event_minutes
      - event_impact_score
      - is_pre_news_zone
      - is_post_news_zone
      - event_type_category
      - actual_vs_forecast_deviation
      - historical_event_volatility
    lookback_hours: 4
    news_blackout_minutes: 15

  # 2. Price Action & Structure Features (18% - 10 features)
  price_action:
    enabled: true
    importance: 0.18
    features:
      - support_resistance_distance
      - is_at_key_level
      - order_block_zone
      - swing_high_low_distance
      - price_rejection_wick
      - h4_trend_direction
      - h4_support_resistance_distance
      - d1_support_resistance_distance
      - w1_swing_high_low
      - multi_tf_alignment
    sr_tolerance_pips: 10
    swing_lookback_candles: 50

  # 3. Multi-Timeframe Context (15% - 9 features)
  multi_timeframe:
    enabled: true
    importance: 0.15
    features:
      - m5_momentum
      - m15_consolidation
      - h1_trend
      - h4_structure
      - d1_bias
      - w1_major_level
      - tf_alignment_score
      - h4_h1_divergence
      - d1_w1_alignment

  # 4. Candlestick Pattern Features (15% - 9 features)
  candlestick_patterns:
    enabled: true
    importance: 0.15
    features:
      - bullish_engulfing
      - bearish_engulfing
      - pin_bar_bullish
      - pin_bar_bearish
      - doji_indecision
      - hammer_reversal
      - shooting_star
      - morning_star
      - evening_star

  # TIER 2: IMPORTANT FEATURES (20-40%)

  # 5. Volume & Order Flow Analysis (15% - 8 features)
  volume_analysis:
    enabled: true
    importance: 0.15
    features:
      - volume_spike
      - volume_profile
      - buying_pressure
      - selling_pressure
      - volume_momentum
      - volume_at_level
      - delta_volume
      - volume_divergence
    volume_spike_threshold: 2.0  # 2x average volume

  # 6. Volatility & Market Regime (12% - 6 features)
  volatility_regime:
    enabled: true
    importance: 0.12
    features:
      - atr_current
      - atr_expansion
      - true_range_pct
      - volatility_regime
      - adx_value
      - bb_width
    atr_periods: 14
    adx_threshold_trending: 25
    adx_threshold_ranging: 20

  # 7. Divergence Detection (10% - 4 features)
  divergence:
    enabled: true
    importance: 0.10
    features:
      - rsi_price_divergence
      - macd_price_divergence
      - volume_price_divergence
      - divergence_strength
    swing_lookback: 5

  # TIER 3: SUPPLEMENTARY FEATURES (<20%)

  # 8. Market Context & Sessions (8% - 6 features)
  market_context:
    enabled: true
    importance: 0.08
    features:
      - is_london_session
      - is_new_york_session
      - liquidity_level
      - time_of_day
      - is_overlap_period
      - session_volatility_avg

  # 9. Momentum Indicators (5% - 3 features)
  momentum_indicators:
    enabled: true
    importance: 0.05
    features:
      - rsi
      - macd
      - stochastic
    use_for: "divergence_only"  # Not for entry signals

  # 10. Moving Averages (2% - 2 features)
  moving_averages:
    enabled: true
    importance: 0.02
    features:
      - sma_200
      - ema_50
    use_for: "dynamic_sr_only"  # Not for crossover signals

  # 11. Fibonacci Retracement & Extension (8% - 9 features) â­ NEW v2.3
  fibonacci:
    enabled: true
    importance: 0.08
    features:
      - fib_current_level
      - fib_distance_to_golden_zone
      - is_in_golden_zone
      - fib_level_strength
      - fib_confluence_score
      - fib_timeframe_alignment
      - fib_extension_target_1272
      - fib_extension_target_1618
      - distance_to_nearest_extension
    swing_lookback_candles: 10
    golden_zone_lower: 0.50   # 50% retracement
    golden_zone_upper: 0.618  # 61.8% retracement (Golden Ratio)
    confluence_tolerance_pips: 10

  # 12. Structure-based SL/TP Features (5% - 5 features)
  structure_sl_tp:
    enabled: true
    importance: 0.05
    features:
      - nearest_support_distance
      - nearest_resistance_distance
      - structure_risk_reward
      - sr_level_strength
      - stop_hunt_zone
    min_rr_ratio: 1.5
    max_risk_pips: 100
    stop_hunt_buffer_pips: 5

# Order Block Detection
order_block:
  enabled: true
  consolidation_threshold: 0.3  # 30% range of impulsive move
  impulsive_move_min_pips: 50
  lookback_candles: 100

# Support/Resistance Detection
support_resistance:
  enabled: true
  clustering_distance_pips: 10
  min_touches: 3
  lookback_candles: 100

# Target Variable Configuration
target:
  type: "binary"  # binary or regression
  prediction_horizon_candles: 1  # Next candle
  profit_threshold_pips: 15  # For labeling as profitable

# Processing Configuration
processing:
  batch_size: 1000
  lookback_candles: 200  # For indicators like EMA_200
  min_data_quality: 0.97  # 97% non-null required

# Logging
logging:
  level: "INFO"
  format: "%(asctime)s | %(levelname)-8s | %(name)-30s | %(message)s"
