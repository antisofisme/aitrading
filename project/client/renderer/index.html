<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Trading Platform - Client Monitor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #ffffff;
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: grid;
      grid-template-rows: 60px 1fr;
      height: 100vh;
    }

    .header {
      background: #2d2d2d;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      border-bottom: 1px solid #404040;
    }

    .logo {
      font-size: 18px;
      font-weight: bold;
      color: #00ff88;
    }

    .status-indicators {
      display: flex;
      gap: 15px;
    }

    .indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
    }

    .indicator.connected {
      background: #00ff8820;
      color: #00ff88;
    }

    .indicator.disconnected {
      background: #ff004420;
      color: #ff4444;
    }

    .indicator.warning {
      background: #ffaa0020;
      color: #ffaa00;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      height: 100%;
    }

    .dashboard {
      display: grid;
      grid-template-rows: 1fr 1fr;
      gap: 20px;
      padding: 20px;
      overflow-y: auto;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .metric-card {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #404040;
    }

    .metric-title {
      font-size: 14px;
      color: #888;
      margin-bottom: 10px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .metric-unit {
      font-size: 12px;
      color: #888;
    }

    .metric-trend {
      font-size: 12px;
      margin-top: 5px;
    }

    .trend-up {
      color: #00ff88;
    }

    .trend-down {
      color: #ff4444;
    }

    .trend-stable {
      color: #888;
    }

    .chart-container {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #404040;
    }

    .chart-title {
      font-size: 16px;
      margin-bottom: 15px;
      color: #ffffff;
    }

    .chart-placeholder {
      height: 200px;
      background: #1a1a1a;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      border: 1px dashed #404040;
    }

    .sidebar {
      background: #2d2d2d;
      border-left: 1px solid #404040;
      display: flex;
      flex-direction: column;
    }

    .sidebar-section {
      padding: 20px;
      border-bottom: 1px solid #404040;
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #ffffff;
    }

    .connection-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .connection-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #1a1a1a;
      border-radius: 4px;
      border: 1px solid #404040;
    }

    .connection-name {
      font-size: 12px;
      font-weight: 500;
    }

    .connection-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 2px;
    }

    .alert-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .alert-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      border-left: 4px solid;
      font-size: 12px;
    }

    .alert-critical {
      background: #ff004410;
      border-color: #ff4444;
      color: #ff4444;
    }

    .alert-warning {
      background: #ffaa0010;
      border-color: #ffaa00;
      color: #ffaa00;
    }

    .alert-info {
      background: #0088ff10;
      border-color: #0088ff;
      color: #0088ff;
    }

    .alert-time {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .controls {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: #00ff88;
      color: #000;
    }

    .btn-primary:hover {
      background: #00cc70;
    }

    .btn-secondary {
      background: #404040;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #505050;
    }

    .btn-danger {
      background: #ff4444;
      color: #fff;
    }

    .btn-danger:hover {
      background: #cc3333;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .dashboard {
        grid-template-rows: auto auto;
        gap: 15px;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="logo">AI Trading Client</div>
      <div class="status-indicators">
        <div class="indicator disconnected" id="mt5-status">
          <div class="status-dot"></div>
          <span>MT5</span>
        </div>
        <div class="indicator disconnected" id="backend-status">
          <div class="status-dot"></div>
          <span>Backend</span>
        </div>
        <div class="indicator warning" id="performance-status">
          <div class="status-dot"></div>
          <span>Performance</span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard -->
      <div class="dashboard">
        <!-- Metrics Grid -->
        <div class="metrics-grid">
          <!-- Ticks Per Second -->
          <div class="metric-card">
            <div class="metric-title">Ticks Per Second</div>
            <div class="metric-value" id="tps-value">0</div>
            <div class="metric-unit">TPS</div>
            <div class="metric-trend trend-stable" id="tps-trend">Target: 50 TPS</div>
          </div>

          <!-- Average Latency -->
          <div class="metric-card">
            <div class="metric-title">Average Latency</div>
            <div class="metric-value" id="latency-value">0</div>
            <div class="metric-unit">ms</div>
            <div class="metric-trend trend-stable" id="latency-trend">Target: &lt;50ms</div>
          </div>

          <!-- Data Processed -->
          <div class="metric-card">
            <div class="metric-title">Data Processed</div>
            <div class="metric-value" id="processed-value">0</div>
            <div class="metric-unit">total</div>
            <div class="metric-trend trend-stable" id="processed-trend">Since startup</div>
          </div>

          <!-- Success Rate -->
          <div class="metric-card">
            <div class="metric-title">Success Rate</div>
            <div class="metric-value" id="success-value">0</div>
            <div class="metric-unit">%</div>
            <div class="metric-trend trend-stable" id="success-trend">Processing accuracy</div>
          </div>

          <!-- Memory Usage -->
          <div class="metric-card">
            <div class="metric-title">Memory Usage</div>
            <div class="metric-value" id="memory-value">0</div>
            <div class="metric-unit">%</div>
            <div class="metric-trend trend-stable" id="memory-trend">System memory</div>
          </div>

          <!-- Target Compliance -->
          <div class="metric-card">
            <div class="metric-title">Target Compliance</div>
            <div class="metric-value" id="compliance-value">0</div>
            <div class="metric-unit">%</div>
            <div class="metric-trend trend-stable" id="compliance-trend">Overall performance</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="chart-container">
          <div class="chart-title">Real-time Performance</div>
          <div class="chart-placeholder" id="performance-chart">
            Performance chart will be displayed here
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Connections -->
        <div class="sidebar-section">
          <div class="sidebar-title">Connections</div>
          <div class="connection-list" id="connection-list">
            <div class="connection-item">
              <span class="connection-name">MT5 Bridge</span>
              <span class="connection-status indicator disconnected">Disconnected</span>
            </div>
            <div class="connection-item">
              <span class="connection-name">Data Bridge</span>
              <span class="connection-status indicator disconnected">Disconnected</span>
            </div>
            <div class="connection-item">
              <span class="connection-name">Backend API</span>
              <span class="connection-status indicator disconnected">Disconnected</span>
            </div>
          </div>
        </div>

        <!-- Alerts -->
        <div class="sidebar-section">
          <div class="sidebar-title">Alerts</div>
          <div class="alert-list" id="alert-list">
            <div class="alert-item alert-info">
              <div>System starting up...</div>
              <div class="alert-time">Just now</div>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls">
          <button class="btn btn-primary" id="connect-btn">Connect All</button>
          <button class="btn btn-secondary" id="restart-btn">Restart Connections</button>
          <button class="btn btn-secondary" id="config-btn">Configuration</button>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // Main application state
    let appState = {
      isConnected: false,
      metrics: {},
      alerts: [],
      connections: {}
    };

    // DOM elements
    const elements = {
      mt5Status: document.getElementById('mt5-status'),
      backendStatus: document.getElementById('backend-status'),
      performanceStatus: document.getElementById('performance-status'),
      tpsValue: document.getElementById('tps-value'),
      tpsTrend: document.getElementById('tps-trend'),
      latencyValue: document.getElementById('latency-value'),
      latencyTrend: document.getElementById('latency-trend'),
      processedValue: document.getElementById('processed-value'),
      processedTrend: document.getElementById('processed-trend'),
      successValue: document.getElementById('success-value'),
      successTrend: document.getElementById('success-trend'),
      memoryValue: document.getElementById('memory-value'),
      memoryTrend: document.getElementById('memory-trend'),
      complianceValue: document.getElementById('compliance-value'),
      complianceTrend: document.getElementById('compliance-trend'),
      connectionList: document.getElementById('connection-list'),
      alertList: document.getElementById('alert-list'),
      connectBtn: document.getElementById('connect-btn'),
      restartBtn: document.getElementById('restart-btn'),
      configBtn: document.getElementById('config-btn')
    };

    // Initialize application
    async function initializeApp() {
      console.log('Initializing AI Trading Client UI...');

      // Setup event listeners
      setupEventListeners();

      // Load initial status
      await updateStatus();

      // Start periodic updates
      setInterval(updateStatus, 1000);
      setInterval(updateMetrics, 500);

      console.log('UI initialized successfully');
    }

    function setupEventListeners() {
      // Button handlers
      elements.connectBtn.addEventListener('click', handleConnect);
      elements.restartBtn.addEventListener('click', handleRestart);
      elements.configBtn.addEventListener('click', handleConfig);

      // Electron API event listeners
      if (window.electronAPI) {
        window.electronAPI.onStatusUpdate(handleStatusUpdate);
        window.electronAPI.onMetricsUpdate(handleMetricsUpdate);
        window.electronAPI.onAlert(handleAlert);
        window.electronAPI.onError(handleError);
      }
    }

    async function updateStatus() {
      try {
        if (window.electronAPI) {
          const status = await window.electronAPI.getStatus();
          updateConnectionStatus(status);
          updateMetricsDisplay(status.performanceMetrics);
        }
      } catch (error) {
        console.error('Error updating status:', error);
        addAlert('error', 'Failed to update status: ' + error.message);
      }
    }

    async function updateMetrics() {
      try {
        if (window.electronAPI) {
          const metrics = await window.electronAPI.getPerformanceMetrics();
          updateDetailedMetrics(metrics);
        }
      } catch (error) {
        console.error('Error updating metrics:', error);
      }
    }

    function updateConnectionStatus(status) {
      // Update MT5 status
      updateStatusIndicator(elements.mt5Status, status.mt5Connected, 'MT5');

      // Update backend status
      updateStatusIndicator(elements.backendStatus, status.dataCollectorConnected, 'Backend');

      // Update performance status based on compliance
      const compliance = status.performanceMetrics?.targets?.currentCompliance || 0;
      const performanceGood = compliance >= 75;
      const performanceWarning = compliance >= 50;

      if (performanceGood) {
        updateStatusIndicator(elements.performanceStatus, true, 'Performance');
      } else if (performanceWarning) {
        elements.performanceStatus.className = 'indicator warning';
      } else {
        updateStatusIndicator(elements.performanceStatus, false, 'Performance');
      }
    }

    function updateStatusIndicator(element, connected, name) {
      element.className = `indicator ${connected ? 'connected' : 'disconnected'}`;
      element.querySelector('span').textContent = name;
    }

    function updateMetricsDisplay(metrics) {
      if (!metrics) return;

      const { dataProcessing, targets, application } = metrics;

      // Ticks per second
      const tps = dataProcessing?.ticksPerSecond || 0;
      elements.tpsValue.textContent = tps.toFixed(1);
      updateTrend(elements.tpsTrend, tps, targets?.ticksPerSecondTarget || 50, 'TPS');

      // Latency
      const latency = dataProcessing?.averageLatency || 0;
      elements.latencyValue.textContent = latency.toFixed(1);
      updateTrend(elements.latencyTrend, latency, targets?.maxLatencyTarget || 50, 'ms', true);

      // Data processed
      const processed = dataProcessing?.totalProcessed || 0;
      elements.processedValue.textContent = formatNumber(processed);
      elements.processedTrend.textContent = 'Since startup';

      // Success rate
      const errors = dataProcessing?.processingErrors || 0;
      const total = processed || 1;
      const successRate = ((total - errors) / total) * 100;
      elements.successValue.textContent = successRate.toFixed(1);
      updateSuccessRateTrend(elements.successTrend, successRate);

      // Memory usage
      const memoryUsage = application?.memoryUsed || 0;
      elements.memoryValue.textContent = memoryUsage.toFixed(1);
      elements.memoryTrend.textContent = 'MB used';

      // Target compliance
      const compliance = targets?.currentCompliance || 0;
      elements.complianceValue.textContent = compliance.toFixed(1);
      updateComplianceTrend(elements.complianceTrend, compliance);
    }

    function updateDetailedMetrics(detailedMetrics) {
      if (!detailedMetrics) return;

      appState.metrics = detailedMetrics;

      // Update connection list
      updateConnectionList(detailedMetrics.current?.connections);

      // Update alerts
      if (detailedMetrics.current?.alerts) {
        updateAlertsList(detailedMetrics.current.alerts.recent || []);
      }
    }

    function updateTrend(element, current, target, unit, inverse = false) {
      const percentage = (current / target) * 100;
      let trend, text;

      if (inverse) {
        // For metrics where lower is better (like latency)
        if (current <= target) {
          trend = 'up';
          text = `✓ Target: <${target}${unit}`;
        } else if (current <= target * 1.5) {
          trend = 'stable';
          text = `⚠ Target: <${target}${unit}`;
        } else {
          trend = 'down';
          text = `✗ Target: <${target}${unit}`;
        }
      } else {
        // For metrics where higher is better
        if (percentage >= 100) {
          trend = 'up';
          text = `✓ Target: ${target}${unit}`;
        } else if (percentage >= 80) {
          trend = 'stable';
          text = `⚠ Target: ${target}${unit}`;
        } else {
          trend = 'down';
          text = `✗ Target: ${target}${unit}`;
        }
      }

      element.className = `metric-trend trend-${trend}`;
      element.innerHTML = text;
    }

    function updateSuccessRateTrend(element, rate) {
      if (rate >= 99) {
        element.className = 'metric-trend trend-up';
        element.textContent = '✓ Excellent';
      } else if (rate >= 95) {
        element.className = 'metric-trend trend-stable';
        element.textContent = '⚠ Good';
      } else {
        element.className = 'metric-trend trend-down';
        element.textContent = '✗ Needs attention';
      }
    }

    function updateComplianceTrend(element, compliance) {
      if (compliance >= 90) {
        element.className = 'metric-trend trend-up';
        element.textContent = '✓ Excellent performance';
      } else if (compliance >= 75) {
        element.className = 'metric-trend trend-stable';
        element.textContent = '⚠ Good performance';
      } else if (compliance >= 50) {
        element.className = 'metric-trend trend-stable';
        element.textContent = '⚠ Fair performance';
      } else {
        element.className = 'metric-trend trend-down';
        element.textContent = '✗ Poor performance';
      }
    }

    function updateConnectionList(connections) {
      if (!connections) return;

      const connectionItems = [
        { name: 'MT5 Bridge', status: connections.mt5?.connected || false },
        { name: 'Data Bridge', status: connections.backend?.connected || false },
        { name: 'Backend API', status: connections.backend?.connected || false }
      ];

      elements.connectionList.innerHTML = connectionItems.map(conn => `
        <div class="connection-item">
          <span class="connection-name">${conn.name}</span>
          <span class="connection-status indicator ${conn.status ? 'connected' : 'disconnected'}">
            ${conn.status ? 'Connected' : 'Disconnected'}
          </span>
        </div>
      `).join('');
    }

    function updateAlertsList(alerts) {
      if (!Array.isArray(alerts)) return;

      elements.alertList.innerHTML = alerts.map(alert => {
        const timeAgo = getTimeAgo(alert.timestamp);
        return `
          <div class="alert-item alert-${getSeverityClass(alert.severity)}">
            <div>${alert.message}</div>
            <div class="alert-time">${timeAgo}</div>
          </div>
        `;
      }).join('');

      if (alerts.length === 0) {
        elements.alertList.innerHTML = '<div class="alert-item alert-info"><div>No alerts</div></div>';
      }
    }

    function getSeverityClass(severity) {
      switch (severity) {
        case 'critical': return 'critical';
        case 'high': return 'warning';
        case 'medium': return 'warning';
        default: return 'info';
      }
    }

    function addAlert(type, message) {
      const alert = {
        type,
        message,
        timestamp: Date.now(),
        severity: type === 'error' ? 'critical' : 'info'
      };

      appState.alerts.unshift(alert);
      appState.alerts = appState.alerts.slice(0, 10); // Keep only recent alerts

      updateAlertsList(appState.alerts);
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);

      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    // Event handlers
    async function handleConnect() {
      try {
        elements.connectBtn.disabled = true;
        elements.connectBtn.textContent = 'Connecting...';

        if (window.electronAPI) {
          await window.electronAPI.restartConnections();
        }

        addAlert('info', 'Connection initiated');
      } catch (error) {
        console.error('Connect failed:', error);
        addAlert('error', 'Connection failed: ' + error.message);
      } finally {
        elements.connectBtn.disabled = false;
        elements.connectBtn.textContent = 'Connect All';
      }
    }

    async function handleRestart() {
      try {
        elements.restartBtn.disabled = true;
        elements.restartBtn.textContent = 'Restarting...';

        if (window.electronAPI) {
          await window.electronAPI.restartConnections();
        }

        addAlert('info', 'Connections restarted');
      } catch (error) {
        console.error('Restart failed:', error);
        addAlert('error', 'Restart failed: ' + error.message);
      } finally {
        elements.restartBtn.disabled = false;
        elements.restartBtn.textContent = 'Restart Connections';
      }
    }

    function handleConfig() {
      // Configuration dialog would be implemented here
      addAlert('info', 'Configuration panel not yet implemented');
    }

    // Electron API event handlers
    function handleStatusUpdate(event, status) {
      updateConnectionStatus(status);
    }

    function handleMetricsUpdate(event, metrics) {
      updateDetailedMetrics(metrics);
    }

    function handleAlert(event, alert) {
      addAlert(alert.severity || 'warning', alert.message);
    }

    function handleError(event, error) {
      addAlert('error', error.message || 'Unknown error occurred');
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>